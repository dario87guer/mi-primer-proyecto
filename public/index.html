<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cobranzas | Dario Morales</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --p: #4f46e5; --s: #10b981; --nav: #1e293b; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; font-size: 14px; overflow-x: auto; }
        .navbar { background: var(--nav); display: flex; padding: 0 30px; position: sticky; top: 0; z-index: 1000; }
        .nav-link { color: #94a3b8; padding: 18px 25px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; }
        .nav-link.active { color: white; border-bottom-color: var(--p); }
        .container { min-width: 1250px; margin: 20px auto; padding: 0 10px; }
        .card-upload { background: white; border-radius: 15px; border: 1px solid #e5e7eb; padding: 25px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-upload h4 { margin: 0 0 15px 0; font-size: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .file-input { width: 100%; padding: 12px; border: 2px dashed #cbd5e1; border-radius: 10px; margin: 15px 0; background: #f8fafc; }
        .btn-group { display: flex; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; height: 42px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-p { background: var(--p); color: white; } .btn-s { background: var(--s); color: white; } .btn-ce { background: #f59e0b; color: white; }
        .result-box { display: none; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .btn-clear { position: absolute; right: 10px; top: 10px; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .bloque-empresa { background: white; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 30px; overflow-x: auto; }
        .bloque-title { padding: 12px 20px; font-size: 16px; font-weight: bold; color: white; text-transform: uppercase; }
        .title-seac { background: #10b981; } .title-pf { background: #3b82f6; } .title-ce { background: #f59e0b; }
        
        .tabla-inf { width: 100%; border-collapse: collapse; table-layout: auto; }
        .tabla-inf th { background: #f8fafc; color: #475569; padding: 10px 5px; border: 1px solid #e2e8f0; font-size: 12px; line-height: 1.3; vertical-align: middle; white-space: normal; font-weight: 500; }
        .tabla-inf td { padding: 8px 4px; border: 1px solid #f1f5f9; text-align: center; font-size: 12px; }
        
        .th-principal { font-weight: 900 !important; font-size: 14px !important; border: 2px solid #334155 !important; color: #1e293b !important; background: #e2e8f0 !important; text-transform: uppercase; }
        .border-left-group { border-left: 3px solid #64748b !important; }
        .border-right-group { border-right: 3px solid #64748b !important; }
        .row-total-final { background: #1e293b !important; color: white !important; font-weight: bold !important; }
        .row-grand-total { background: #4f46e5 !important; color: white !important; font-weight: 900 !important; }
        
        .controls-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .control-item { display: flex; flex-direction: column; gap: 4px; font-weight: 600; color: #475569; font-size: 14px; }
        input[type="date"], select { padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; height: 42px; font-family: inherit; font-size: 14px; box-sizing: border-box; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 2000; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .grid-config { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .icon-btn { background: #f1f5f9; border: none; cursor: pointer; padding: 6px; border-radius: 6px; }
    </style>
</head>
<body onload="initApp()">

<div class="navbar">
    <div class="nav-link active" onclick="switchTab(event, 'tab-import')">üì• Importar</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-config')">‚öôÔ∏è Red</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-informes')">üìä Diario</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-mensual')" style="color: #fbbf24">üìà Mensual</div>
</div>

<div class="container">
    <div id="prog-box" class="card-upload" style="display:none; text-align:center; border: 2px solid var(--p);">
        <div id="prog-txt" style="font-weight:bold; margin-bottom:10px; color: var(--p);">Procesando...</div>
        <div style="background:#e2e8f0; height:20px; border-radius:10px; overflow:hidden;">
            <div id="bar-fill" style="background:var(--p); width:0%; height:100%; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0%</div>
        </div>
    </div>

    <div id="tab-import" class="tab-content active">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
            <div class="card-upload">
                <h4>üü¢ SEAC</h4>
                <div id="res-seac" class="result-box"><button class="btn-clear" onclick="limpiarRes('res-seac')">Limpiar</button><div class="res-content"></div></div>
                <input type="file" id="fileSEAC" multiple class="file-input">
                <div class="btn-group">
                    <button class="btn btn-p" onclick="procesar('seac', 'fileSEAC', 'ventas', 'res-seac')">VENTAS</button>
                    <button class="btn btn-s" onclick="procesar('seac', 'fileSEAC', 'debitos', 'res-seac')">D√âBITOS</button>
                </div>
            </div>
            <div class="card-upload">
                <h4>üü† Cobro Express</h4>
                <div id="res-ce" class="result-box"><button class="btn-clear" onclick="limpiarRes('res-ce')">Limpiar</button><div class="res-content"></div></div>
                <input type="file" id="fileCE" multiple accept=".xlsx" class="file-input">
                <div class="btn-group">
                    <button class="btn btn-p" onclick="procesar('cobroexpress', 'fileCE', 'detallado', 'res-ce')">1. DETALLE</button>
                    <button class="btn btn-ce" onclick="procesar('cobroexpress', 'fileCE', 'diario', 'res-ce')">2. DIARIO</button>
                </div>
            </div>
        </div>
        <div class="card-upload" style="margin-top:25px;">
            <h4>üîµ Pago F√°cil</h4>
            <div id="res-pf" class="result-box"><button class="btn-clear" onclick="limpiarRes('res-pf')">Limpiar</button><div class="res-content"></div></div>
            <input type="file" id="filePF" multiple accept=".txt" class="file-input">
            <button class="btn btn-p" style="width:200px" onclick="procesar('pagofacil', 'filePF', null, 'res-pf')">SUBIR .TXT</button>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2>Gesti√≥n de Red</h2><button class="btn btn-p" style="flex:none; width:180px;" onclick="nuevaSucursal()">+ Nueva Sucursal</button></div>
        <div id="grid-arbol" class="grid-config"></div>
    </div>

    <div id="tab-informes" class="tab-content">
        <div class="card-upload controls-row">
            <div class="control-item">Desde <input type="date" id="fDesde"></div>
            <div class="control-item">Hasta <input type="date" id="fHasta"></div>
            <div class="control-item">Sucursal <select id="selSucDiario"><option value="TODAS">TODAS</option></select></div>
            <button class="btn btn-p" style="align-self: flex-end;" onclick="cargarInforme()">CONSULTAR DIARIO</button>
            <button class="btn btn-s" style="align-self: flex-end;" onclick="exportarTabla('contenedorInformes', 'Informe_Diario')">EXPORTAR EXCEL</button>
        </div>
        <div id="contenedorInformes"></div>
    </div>

    <div id="tab-mensual" class="tab-content">
        <div class="card-upload controls-row">
            <div class="control-item">Desde <input type="date" id="mDesde"></div>
            <div class="control-item">Hasta <input type="date" id="mHasta"></div>
            <button class="btn btn-p" style="align-self: flex-end;" onclick="cargarMensual()">GENERAR MENSUAL</button>
            <button class="btn btn-s" style="align-self: flex-end;" onclick="exportarTabla('contenedorMensual', 'Informe_Mensual')">EXPORTAR EXCEL</button>
        </div>
        <div id="contenedorMensual"></div>
    </div>
</div>

<div id="modalTerm" class="modal"><div class="modal-content"><h3>Nueva Terminal</h3><input type="hidden" id="mCajaId">
    <div style="margin-bottom:15px;"><label style="font-weight:bold; display:block; margin-bottom:5px;">Empresa:</label><select id="mEmp" style="width:100%;"><option value="PAGO F√ÅCIL">PAGO F√ÅCIL</option><option value="SEAC">SEAC</option><option value="COBRO EXPRESS">COBRO EXPRESS</option></select></div>
    <div style="margin-bottom:15px;"><label style="font-weight:bold; display:block; margin-bottom:5px;">ID / PDV:</label><input type="text" id="mId" style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px;"></div>
    <div class="btn-group"><button class="btn btn-p" onclick="guardarTerm()">Guardar</button><button class="btn" style="background:#ddd" onclick="document.getElementById('modalTerm').style.display='none'">Cerrar</button></div>
</div></div>

<script>
    function fmt(n) { 
        if (n === null || n === undefined || isNaN(n)) return "0,00";
        return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n); 
    }

    const evtSource = new EventSource("/api/progress");
    evtSource.onmessage = (e) => {
        const d = JSON.parse(e.data);
        const pFill = document.getElementById('bar-fill');
        const pTxt = document.getElementById('prog-txt');
        if(pFill && pTxt) { pFill.style.width = d.p+'%'; pFill.innerText = d.p+'%'; pTxt.innerText = d.t; }
    };

    async function procesar(ruta, inId, tipo, resId) {
        const input = document.getElementById(inId);
        if (input.files.length === 0) return alert("Seleccione archivos.");
        document.getElementById('prog-box').style.display = 'block';
        let totN = 0, totE = 0, totD = 0;
        for (let f of input.files) {
            const fd = new FormData(); fd.append('archivo', f); if(tipo) fd.append('tipo', tipo);
            try { 
                const res = await fetch(`/importar/${ruta}`, { method:'POST', body:fd }); 
                const d = await res.json(); totN += (d.nuevos || 0); totE += (d.errores || 0); totD += (d.omitidos || 0);
            } catch(ex) { console.error(ex); totE++; }
        }
        const rBox = document.getElementById(resId);
        rBox.style.display = 'block';
        rBox.querySelector('.res-content').innerHTML = `<b>üìä Resumen de Carga:</b><br>‚úÖ Nuevos: ${totN} | ‚ö†Ô∏è Duplicados / Omitidos: ${totD} | ‚ùå Errores: ${totE}`;
        input.value = ""; document.getElementById('prog-box').style.display = 'none';
    }

    function limpiarRes(id) { document.getElementById(id).style.display = 'none'; }

    function exportarTabla(idContenedor, nombreBase) {
        const cont = document.getElementById(idContenedor);
        if (!cont.innerHTML.trim()) return alert("No hay datos para exportar.");
        const wb = XLSX.utils.book_new();
        const tablas = cont.querySelectorAll('table');
        tablas.forEach((t, i) => { const ws = XLSX.utils.table_to_sheet(t); XLSX.utils.book_append_sheet(wb, ws, `Hoja_${i+1}`); });
        XLSX.writeFile(wb, `${nombreBase}_${new Date().toLocaleDateString()}.xlsx`);
    }

    async function cargarMensual() {
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('mDesde').value}&hasta=${document.getElementById('mHasta').value}`)).json();
        const cont = document.getElementById('contenedorMensual'); cont.innerHTML = '';
        const dataEmp = { 
            "seac": { title: "SEAC", class: "title-seac", locales: {}, cols: 5 }, 
            "pf": { title: "PAGO F√ÅCIL", class: "title-pf", locales: {}, cols: 5 }, 
            "ce": { title: "COBRO EXPRESS", class: "title-ce", locales: {}, cols: 10 } 
        };
        res.forEach(r => {
            if(!dataEmp.seac.locales[r.suc_nombre]) dataEmp.seac.locales[r.suc_nombre] = Array(5).fill(0);
            if(!dataEmp.pf.locales[r.suc_nombre]) dataEmp.pf.locales[r.suc_nombre] = Array(5).fill(0);
            if(!dataEmp.ce.locales[r.suc_nombre]) dataEmp.ce.locales[r.suc_nombre] = Array(10).fill(0);
            dataEmp.seac.locales[r.suc_nombre][0]+=parseFloat(r.seac_cant_e||0); dataEmp.seac.locales[r.suc_nombre][1]+=parseFloat(r.seac_monto_e||0); dataEmp.seac.locales[r.suc_nombre][2]+=parseFloat(r.seac_cant_d||0); dataEmp.seac.locales[r.suc_nombre][3]+=parseFloat(r.seac_monto_d||0); dataEmp.seac.locales[r.suc_nombre][4]+=(parseFloat(r.seac_monto_e||0)+parseFloat(r.seac_monto_d||0));
            dataEmp.pf.locales[r.suc_nombre][0]+=parseFloat(r.pf_cant_e||0); dataEmp.pf.locales[r.suc_nombre][1]+=parseFloat(r.pf_monto_e||0); dataEmp.pf.locales[r.suc_nombre][2]+=parseFloat(r.pf_cant_d||0); dataEmp.pf.locales[r.suc_nombre][3]+=parseFloat(r.pf_monto_d||0); dataEmp.pf.locales[r.suc_nombre][4]+=(parseFloat(r.pf_monto_e||0)+parseFloat(r.pf_monto_d||0));
            const mEf = parseFloat(r.ce_monto_e||0), mDe = parseFloat(r.ce_monto_d||0), dev = parseFloat(r.ce_dev||0), exEf = parseFloat(r.ce_extra_e||0), exDe = parseFloat(r.ce_extra_d||0);
            const subCE = (mEf + mDe - exEf - exDe - dev);
            dataEmp.ce.locales[r.suc_nombre][0]+=parseFloat(r.ce_cant_e||0); dataEmp.ce.locales[r.suc_nombre][1]+=mEf; dataEmp.ce.locales[r.suc_nombre][2]+=dev; dataEmp.ce.locales[r.suc_nombre][3]+=(mEf-dev); dataEmp.ce.locales[r.suc_nombre][4]+=exEf; dataEmp.ce.locales[r.suc_nombre][5]+=parseFloat(r.ce_cant_d||0); dataEmp.ce.locales[r.suc_nombre][6]+=mDe; dataEmp.ce.locales[r.suc_nombre][7]+=exDe; dataEmp.ce.locales[r.suc_nombre][8]+=(parseFloat(r.ce_cant_e||0)+parseFloat(r.ce_cant_d||0)); dataEmp.ce.locales[r.suc_nombre][9]+=subCE;
        });
        for (let key in dataEmp) {
            const emp = dataEmp[key];
            let html = `<div class="bloque-empresa"><div class="bloque-title ${emp.class}">${emp.title} - TOTALES ACUMULADOS</div><table class="tabla-inf"><thead><tr><th>NOMBRE LOCAL</th><th class="th-principal border-left-group">CANTIDAD<br>EFECTIVO</th><th>MONTO<br>EFECTIVO</th>${key==='ce'?'<th>DEVOLUCIONES<br>RESUMIDO</th><th>EFECTIVO MENOS<br>DEVOLUCIONES</th><th>EXTRA SERVICIO<br>EFECTIVO</th>':''}<th>CANTIDAD<br>D√âBITO</th><th>MONTO<br>D√âBITO</th>${key==='ce'?'<th>EXTRA SERVICIO<br>D√âBITO</th><th>CANTIDAD<br>TOTAL</th>':''}<th class="border-right-group">SUBTOTAL<br>FINAL</th></tr></thead><tbody>`;
            let finalT = Array(emp.cols).fill(0);
            for (let loc in emp.locales) { 
                html += `<tr><td style="text-align:left; font-weight:bold">${loc}</td>`; 
                emp.locales[loc].forEach((v,i)=>{ 
                    const isCant = (key==='seac' || key==='pf') ? (i===0 || i===2) : (i===0 || i===5 || i===8);
                    const groupClass = (i === 0) ? 'border-left-group' : (i === emp.cols - 1) ? 'border-right-group' : '';
                    html += `<td class="${groupClass}">${isCant ? parseInt(v) : fmt(v)}</td>`; finalT[i]+=v; 
                }); html += `</tr>`; 
            }
            html += `<tr class="row-total-final"><td style="text-align:left">TOTAL COLUMNAS</td>`; 
            finalT.forEach((t, i) => { const isCant = (key==='seac' || key==='pf') ? (i===0 || i===2) : (i===0 || i===5 || i===8); const groupClass = (i === 0) ? 'border-left-group' : (i === emp.cols - 1) ? 'border-right-group' : ''; html += `<td class="${groupClass}">${isCant ? parseInt(t) : fmt(t)}</td>`; }); html += `</tr>`;
            let gC = (key==='ce') ? finalT[8] : (finalT[0]+finalT[2]), gM = (key==='ce') ? finalT[9] : finalT[4];
            html += `<tr class="row-grand-total"><td style="text-align:left">GRAN TOTAL RED ${emp.title}</td><td colspan="${key==='ce'?7:3}" style="text-align:right">CANTIDAD TOTAL: ${parseInt(gC)}</td><td colspan="2" style="text-align:right">IMPORTE TOTAL RECAUDADO: $ ${fmt(gM)}</td></tr></tbody></table></div>`;
            cont.innerHTML += html;
        }
    }

    async function cargarInforme() {
        const filtro = document.getElementById('selSucDiario').value;
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('fDesde').value}&hasta=${document.getElementById('fHasta').value}`)).json();
        const cont = document.getElementById('contenedorInformes'); cont.innerHTML = '';
        const sucs = {}; res.forEach(r => { if(filtro !== "TODAS" && r.suc_nombre !== filtro) return; if(!sucs[r.suc_nombre]) sucs[r.suc_nombre] = []; sucs[r.suc_nombre].push(r); });
        for (let sNombre in sucs) {
            let html = `<div class="bloque-empresa"><div class="bloque-title" style="background:#334155">LOCAL: ${sNombre}</div><table class="tabla-inf"><thead><tr><th rowspan="2">FECHA<br>COBRO</th><th rowspan="2">NOMBRE<br>CAJA</th><th colspan="4" class="th-principal border-left-group border-right-group">PAGO F√ÅCIL</th><th colspan="4" class="th-principal border-right-group">SEAC</th><th colspan="8" class="th-principal border-right-group">COBRO EXPRESS</th><th rowspan="2">SUBTOTAL<br>CAJA</th></tr><tr><th class="border-left-group">CANTIDAD<br>EFECTIVO</th><th>MONTO<br>EFECTIVO</th><th>CANTIDAD<br>D√âBITO</th><th class="border-right-group">MONTO<br>D√âBITO</th><th>CANTIDAD<br>EFECTIVO</th><th>MONTO<br>EFECTIVO</th><th>CANTIDAD<br>D√âBITO</th><th class="border-right-group">MONTO<br>D√âBITO</th><th>CANTIDAD<br>EFECTIVO</th><th>MONTO<br>EFECTIVO</th><th>DEV.</th><th>EFECTIVO -<br>DEVOLUCIONES</th><th>EXTRA<br>EFECTIVO</th><th>CANTIDAD<br>D√âBITO</th><th>MONTO<br>D√âBITO</th><th class="border-right-group">EXTRA<br>D√âBITO</th></tr></thead><tbody>`;
            let st = Array(17).fill(0);
            sucs[sNombre].forEach(r => {
                const mEf = parseFloat(r.ce_monto_e||0), dev = parseFloat(r.ce_dev||0);
                const subCE = (mEf + parseFloat(r.ce_monto_d||0) - parseFloat(r.ce_extra_e||0) - parseFloat(r.ce_extra_d||0) - dev);
                const subT = (parseFloat(r.pf_monto_e||0)+parseFloat(r.pf_monto_d||0)) + (parseFloat(r.seac_monto_e||0)+parseFloat(r.seac_monto_d||0)) + subCE;
                const v = [r.pf_cant_e, r.pf_monto_e, r.pf_cant_d, r.pf_monto_d, r.seac_cant_e, r.seac_monto_e, r.seac_cant_d, r.seac_monto_d, r.ce_cant_e, mEf, dev, (mEf-dev), r.ce_extra_e, r.ce_cant_d, r.ce_monto_d, r.ce_extra_d];
                v.forEach((val, i) => st[i] += parseFloat(val || 0)); st[16] += subT;
                html += `<tr><td>${new Date(r.fecha).toLocaleDateString()}</td><td>${r.nombre_caja}</td><td class="border-left-group">${parseInt(v[0])}</td><td>${fmt(v[1])}</td><td>${parseInt(v[2])}</td><td class="border-right-group">${fmt(v[3])}</td><td>${parseInt(v[4])}</td><td>${fmt(v[5])}</td><td>${parseInt(v[6])}</td><td class="border-right-group">${fmt(v[7])}</td><td>${parseInt(v[8])}</td><td>${fmt(v[9])}</td><td style="color:red">${fmt(v[10])}</td><td style="font-weight:bold">${fmt(v[11])}</td><td>${fmt(v[12])}</td><td>${parseInt(v[13])}</td><td>${fmt(v[14])}</td><td class="border-right-group">${fmt(v[15])}</td><td style="font-weight:bold">${fmt(subT)}</td></tr>`;
            });
            html += `<tr class="row-total-final"><td colspan="2">TOTAL LOCAL</td><td class="border-left-group">${parseInt(st[0])}</td><td>${fmt(st[1])}</td><td>${parseInt(st[2])}</td><td class="border-right-group">${fmt(st[3])}</td><td>${parseInt(st[4])}</td><td>${fmt(st[5])}</td><td>${parseInt(st[6])}</td><td class="border-right-group">${fmt(st[7])}</td><td>${parseInt(st[8])}</td><td>${fmt(st[9])}</td><td>${fmt(st[10])}</td><td>${fmt(st[11])}</td><td>${fmt(st[12])}</td><td>${parseInt(st[13])}</td><td>${fmt(st[14])}</td><td class="border-right-group">${fmt(st[15])}</td><td>${fmt(st[16])}</td></tr></tbody></table></div>`; cont.innerHTML += html;
        }
    }

    async function cargarArbol() {
        const res = await fetch('/api/arbol-configuracion'); const data = await res.json();
        const grid = document.getElementById('grid-arbol'); grid.innerHTML = ''; const sucs = {};
        const selD = document.getElementById('selSucDiario');
        selD.innerHTML = '<option value="TODAS">TODAS</option>';
        data.forEach(r => {
            if (!sucs[r.suc_id]) { 
                sucs[r.suc_id] = { id: r.suc_id, nombre: r.suc_nombre, cajas: {} };
                selD.innerHTML += `<option value="${r.suc_nombre}">${r.suc_nombre}</option>`;
            }
            if (r.caja_id && !sucs[r.suc_id].cajas[r.caja_id]) sucs[r.suc_id].cajas[r.caja_id] = { id: r.caja_id, nombre: r.nombre_caja, terminales: [] };
            if (r.term_id) sucs[r.suc_id].cajas[r.caja_id].terminales.push(r);
        });
        for (let sid in sucs) {
            const s = sucs[sid];
            let h = `<div class="card-upload"><div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:10px; margin-bottom:10px;"><strong>üèõÔ∏è ${s.nombre}</strong><div><button class="icon-btn" onclick="editN('sucursales',${s.id},'${s.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="nuevaCaja(${s.id})">‚ûï</button><button class="icon-btn" onclick="borrar('sucursales',${s.id})">üóëÔ∏è</button></div></div>`;
            for (let cid in s.cajas) {
                const c = s.cajas[cid]; h += `<div style="padding:10px; background:#f8fafc; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between;"><span>üì¶ <b>Caja:</b> ${c.nombre}</span><div><button class="icon-btn" onclick="abrirModal(${c.id})">‚ûï</button><button class="icon-btn" onclick="editN('cajas',${c.id},'${c.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="borrar('cajas',${c.id})">üóëÔ∏è</button></div></div>`;
                c.terminales.forEach(t => { h += `<div style="padding:5px 10px 5px 35px; font-size:12px; display:flex; justify-content:space-between;"><span>üíª ${t.empresa}: ${t.identificador_externo}</span><button class="icon-btn" style="font-size:10px;" onclick="borrar('terminales',${t.term_id})">üóëÔ∏è</button></div>`; });
            }
            h += `</div>`; grid.innerHTML += h;
        }
    }

    function initApp() { 
        const h = new Date(); 
        document.getElementById('fDesde').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('fHasta').value = new Date(h.getFullYear(), h.getMonth() + 1, 0).toISOString().split('T')[0];
        document.getElementById('mDesde').value = document.getElementById('fDesde').value;
        document.getElementById('mHasta').value = document.getElementById('fHasta').value;
        cargarArbol(); 
    }
    function switchTab(e, id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.getElementById(id).classList.add('active'); e.target.classList.add('active'); if(id === 'tab-config') cargarArbol(); }
    async function editN(t,id,a) { const n = prompt("Editar nombre:",a); if(n) { await fetch(`/api/${t}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); cargarArbol(); } }
    async function borrar(t,id) { if(confirm("¬øEliminar?")) { await fetch(`/api/${t}/${id}`,{method:'DELETE'}); cargarArbol(); } }
    async function nuevaCaja(sid) { const n = prompt("Nombre caja:"); if(n) { await fetch('/api/cajas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sucursal_id:sid, nombre:n})}); cargarArbol(); } }
    async function nuevaSucursal() { const n = prompt("Nombre sucursal:"); if(n) { await fetch('/api/sucursales',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); cargarArbol(); } }
    
    // FUNCIONES MODAL TERMINAL RESTAURADAS
    function abrirModal(cid) { document.getElementById('mCajaId').value = cid; document.getElementById('modalTerm').style.display = 'flex'; }
    async function guardarTerm() { 
        const b = { caja_id: document.getElementById('mCajaId').value, empresa: document.getElementById('mEmp').value, identificador: document.getElementById('mId').value }; 
        if(!b.identificador) return alert("Ingrese ID");
        await fetch('/api/terminales', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b) }); 
        document.getElementById('modalTerm').style.display = 'none'; document.getElementById('mId').value=""; cargarArbol(); 
    }
</script>
</body>
</html>