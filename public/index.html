<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cobranzas | Dario Morales</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --p: #4f46e5; --s: #10b981; --nav: #1e293b; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; font-size: 14px; overflow-x: auto; }
        .navbar { background: var(--nav); display: flex; padding: 0 10px; position: sticky; top: 0; z-index: 1000; overflow-x: auto; }
        .nav-link { color: #94a3b8; padding: 15px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; white-space: nowrap; }
        .nav-link.active { color: white; border-bottom-color: var(--p); }
        
        .container { min-width: 360px; max-width: 100%; margin: 10px auto; padding: 0 10px; box-sizing: border-box; }
        
        /* CARD ADAPTATION */
        .card-upload { background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-upload h4 { margin: 0 0 10px 0; font-size: 18px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        
        .file-input { width: 100%; padding: 10px; border: 2px dashed #cbd5e1; border-radius: 8px; margin: 10px 0; background: #f8fafc; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 12px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; min-height: 44px; flex: 1; min-width: 120px; }
        .btn-p { background: var(--p); color: white; } .btn-s { background: var(--s); color: white; }
        
        /* TABLAS RESPONSIVE */
        .bloque-empresa { background: white; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabla-inf { width: 100%; border-collapse: collapse; min-width: 1000px; }
        .tabla-inf th, .tabla-inf td { padding: 8px 4px; border: 1px solid #f1f5f9; text-align: center; font-size: 12px; }
        .th-principal { font-weight: 900 !important; font-size: 13px !important; border: 2px solid #334155 !important; background: #e2e8f0 !important; text-transform: uppercase; }
        
        /* CONTROLES ALINEADOS */
        .controls-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .control-item { display: flex; flex-direction: column; gap: 2px; font-weight: 600; font-size: 13px; }
        input[type="date"], select, input[type="number"] { padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; height: 40px; font-size: 14px; }

        /* MODAL */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index: 2000; padding: 10px; box-sizing: border-box; }
        .modal-content { background:white; padding:20px; border-radius:15px; width:100%; max-width: 400px; box-sizing: border-box; }

        /* GRID RED */
        .grid-config { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .icon-btn { background: #f1f5f9; border: none; cursor: pointer; padding: 8px; border-radius: 6px; font-size: 16px; }

        @media (max-width: 600px) {
            .nav-link { padding: 12px 10px; font-size: 13px; }
            .btn { width: 100%; }
            .controls-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body onload="initApp()">

<div class="navbar">
    <div class="nav-link active" onclick="switchTab(event, 'tab-import')">üì• Importar</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-config')">‚öôÔ∏è Red</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-informes')">üìä Diario</div>
    <div class="nav-link" onclick="switchTab(event, 'tab-mensual')" style="color: #fbbf24">üìà Mensual</div>
</div>

<div class="container">
    <div id="prog-box" class="card-upload" style="display:none; text-align:center; border: 2px solid var(--p);">
        <div id="prog-txt" style="font-weight:bold; margin-bottom:10px; color: var(--p);">Procesando...</div>
        <div style="background:#e2e8f0; height:15px; border-radius:10px; overflow:hidden;">
            <div id="bar-fill" style="background:var(--p); width:0%; height:100%; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0%</div>
        </div>
    </div>

    <div id="tab-import" class="tab-content active">
        <div class="card-upload">
            <h4>üü¢ SEAC</h4>
            <div id="res-seac" class="result-box" style="display:none; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; margin-bottom:10px;"><div class="res-content"></div></div>
            <input type="file" id="fileSEAC" multiple class="file-input">
            <div class="btn-group">
                <button class="btn btn-p" onclick="procesar('seac', 'fileSEAC', 'ventas', 'res-seac')">VENTAS</button>
                <button class="btn btn-s" onclick="procesar('seac', 'fileSEAC', 'debitos', 'res-seac')">D√âBITOS</button>
            </div>
        </div>
        <div class="card-upload">
            <h4>üü† Cobro Express</h4>
            <div id="res-ce" class="result-box" style="display:none; padding:10px; background:#fffbeb; border:1px solid #fde68a; border-radius:8px; margin-bottom:10px;"><div class="res-content"></div></div>
            <input type="file" id="fileCE" multiple class="file-input">
            <div class="btn-group">
                <button class="btn btn-p" onclick="procesar('cobroexpress', 'fileCE', 'detallado', 'res-ce')">1. DETALLE</button>
                <button class="btn btn-s" style="background:#f59e0b" onclick="procesar('cobroexpress', 'fileCE', 'diario', 'res-ce')">2. DIARIO</button>
            </div>
        </div>
        <div class="card-upload">
            <h4>üîµ Pago F√°cil</h4>
            <div id="res-pf" class="result-box" style="display:none; padding:10px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; margin-bottom:10px;"><div class="res-content"></div></div>
            <input type="file" id="filePF" multiple class="file-input">
            <button class="btn btn-p" style="width:100%" onclick="procesar('pagofacil', 'filePF', null, 'res-pf')">SUBIR .TXT</button>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items: center;"><h2>Gesti√≥n de Red</h2><button class="btn btn-p" style="max-width:180px;" onclick="nuevaSucursal()">+ Sucursal</button></div>
        <div id="grid-arbol" class="grid-config"></div>
    </div>

    <div id="tab-informes" class="tab-content">
        <div class="card-upload controls-row">
            <div class="control-item">Desde <input type="date" id="fDesde"></div>
            <div class="control-item">Hasta <input type="date" id="fHasta"></div>
            <div class="control-item">Sucursal <select id="selSucDiario"><option value="TODAS">TODAS</option></select></div>
            <button class="btn btn-p" onclick="cargarInforme()">CONSULTAR</button>
            <button class="btn btn-s" onclick="exportarTabla('contenedorInformes', 'Diario')">EXCEL</button>
        </div>
        <div id="contenedorInformes"></div>
    </div>

    <div id="tab-mensual" class="tab-content">
        <div class="card-upload controls-row">
            <div class="control-item">Desde <input type="date" id="mDesde"></div>
            <div class="control-item">Hasta <input type="date" id="mHasta"></div>
            <button class="btn btn-p" onclick="cargarMensual()">GENERAR</button>
            <button class="btn btn-s" onclick="exportarTabla('contenedorMensual', 'Mensual')">EXCEL</button>
        </div>
        <div id="contenedorMensual"></div>
    </div>
</div>

<div id="modalTerm" class="modal"><div class="modal-content"><h3>Terminal / Comisiones</h3><input type="hidden" id="mCajaId">
    <div style="margin-bottom:12px;"><label>Empresa:</label><select id="mEmp" style="width:100%;"><option value="PAGO F√ÅCIL">PAGO F√ÅCIL</option><option value="SEAC">SEAC</option><option value="COBRO EXPRESS">COBRO EXPRESS</option></select></div>
    <div style="margin-bottom:12px;"><label>ID / PDV:</label><input type="text" id="mId" style="width:100%;"></div>
    <div style="margin-bottom:15px;"><label>Comisi√≥n % (opcional):</label><input type="number" id="mCom" step="0.01" value="0" style="width:100%;"></div>
    <div class="btn-group"><button class="btn btn-p" onclick="guardarTerm()">Guardar</button><button class="btn" style="background:#ddd" onclick="document.getElementById('modalTerm').style.display='none'">Cerrar</button></div>
</div></div>

<script>
    function fmt(n) { 
        if (n === null || n === undefined || isNaN(n)) return "0,00";
        return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n); 
    }

    async function procesar(ruta, inId, tipo, resId) {
        const input = document.getElementById(inId);
        if (input.files.length === 0) return alert("Seleccione archivos.");
        document.getElementById('prog-box').style.display = 'block';
        let totN = 0, totE = 0, totD = 0;
        for (let f of input.files) {
            const fd = new FormData(); fd.append('archivo', f); if(tipo) fd.append('tipo', tipo);
            try { 
                const res = await fetch(`/importar/${ruta}`, { method:'POST', body:fd }); 
                const d = await res.json(); 
                if(res.ok) { totN += (d.nuevos || 0); totE += (d.errores || 0); totD += (d.omitidos || 0); }
                else { throw new Error(d.error || "Error en servidor"); }
            } catch(ex) { alert("Error: " + ex.message); totE++; }
        }
        const rBox = document.getElementById(resId);
        rBox.style.display = 'block';
        rBox.querySelector('.res-content').innerHTML = `<b>üìä Resumen:</b> ‚úÖ ${totN} | ‚ö†Ô∏è ${totD} | ‚ùå ${totE}`;
        input.value = ""; document.getElementById('prog-box').style.display = 'none';
    }

    function exportarTabla(id, name) {
        const cont = document.getElementById(id);
        if (!cont.innerHTML.trim()) return alert("Sin datos.");
        const wb = XLSX.utils.book_new();
        cont.querySelectorAll('table').forEach((t, i) => XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(t), `Hoja_${i+1}`));
        XLSX.writeFile(wb, `${name}_${new Date().toLocaleDateString()}.xlsx`);
    }

    async function cargarMensual() {
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('mDesde').value}&hasta=${document.getElementById('mHasta').value}`)).json();
        const cont = document.getElementById('contenedorMensual'); cont.innerHTML = '';
        const dataEmp = { "seac": { title: "SEAC", cl: "title-seac", loc: {} }, "pf": { title: "PAGO F√ÅCIL", cl: "title-pf", loc: {} }, "ce": { title: "COBRO EXPRESS", cl: "title-ce", loc: {} } };
        res.forEach(r => {
            ["seac","pf","ce"].forEach(k => { if(!dataEmp[k].loc[r.suc_nombre]) dataEmp[k].loc[r.suc_nombre] = Array(k==="ce"?10:5).fill(0); });
            dataEmp.seac.loc[r.suc_nombre][0]+=parseFloat(r.seac_cant_e||0); dataEmp.seac.loc[r.suc_nombre][1]+=parseFloat(r.seac_monto_e||0); dataEmp.seac.loc[r.suc_nombre][2]+=parseFloat(r.seac_cant_d||0); dataEmp.seac.loc[r.suc_nombre][3]+=parseFloat(r.seac_monto_d||0); dataEmp.seac.loc[r.suc_nombre][4]+=((parseFloat(r.seac_monto_e||0)+parseFloat(r.seac_monto_d||0)));
            dataEmp.pf.loc[r.suc_nombre][0]+=parseFloat(r.pf_cant_e||0); dataEmp.pf.loc[r.suc_nombre][1]+=parseFloat(r.pf_monto_e||0); dataEmp.pf.loc[r.suc_nombre][2]+=parseFloat(r.pf_cant_d||0); dataEmp.pf.loc[r.suc_nombre][3]+=parseFloat(r.pf_monto_d||0); dataEmp.pf.loc[r.suc_nombre][4]+=((parseFloat(r.pf_monto_e||0)+parseFloat(r.pf_monto_d||0)));
            const mEf = parseFloat(r.ce_monto_e||0), mDe = parseFloat(r.ce_monto_d||0), dev = parseFloat(r.ce_dev||0), exEf = parseFloat(r.ce_extra_e||0), exDe = parseFloat(r.ce_extra_d||0);
            const subCE = (mEf + mDe - exEf - exDe - dev);
            dataEmp.ce.loc[r.suc_nombre][0]+=parseFloat(r.ce_cant_e||0); dataEmp.ce.loc[r.suc_nombre][1]+=mEf; dataEmp.ce.loc[r.suc_nombre][2]+=dev; dataEmp.ce.loc[r.suc_nombre][3]+=(mEf-dev); dataEmp.ce.loc[r.suc_nombre][4]+=exEf; dataEmp.ce.loc[r.suc_nombre][5]+=parseFloat(r.ce_cant_d||0); dataEmp.ce.loc[r.suc_nombre][6]+=mDe; dataEmp.ce.loc[r.suc_nombre][7]+=exDe; dataEmp.ce.loc[r.suc_nombre][8]+=(parseFloat(r.ce_cant_e||0)+parseFloat(r.ce_cant_d||0)); dataEmp.ce.loc[r.suc_nombre][9]+=subCE;
        });
        for (let k in dataEmp) {
            const e = dataEmp[k];
            let h = `<div class="bloque-empresa"><div class="bloque-title ${e.cl}">${e.title}</div><table class="tabla-inf"><thead><tr><th>LOCAL</th><th>CANT. EFEC.</th><th>MONTO EFEC.</th>${k==='ce'?'<th>DEV.</th><th>EFEC-DEV</th><th>EXT. EFEC.</th>':''}<th>CANT. D√âB.</th><th>MONTO D√âB.</th>${k==='ce'?'<th>EXT. D√âB.</th><th>CANT. TOTAL</th>':''}<th>SUBTOTAL</th></tr></thead><tbody>`;
            for (let l in e.loc) { h += `<tr><td style="text-align:left; font-weight:bold">${l}</td>`; e.loc[l].forEach((v,i)=> h += `<td>${([0,2,5,8].includes(i)&&(k==='ce')||[0,2].includes(i)&&k!=='ce') ? parseInt(v) : fmt(v)}</td>`); h += `</tr>`; }
            cont.innerHTML += h + `</tbody></table></div>`;
        }
    }

    async function cargarInforme() {
        const filtro = document.getElementById('selSucDiario').value;
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('fDesde').value}&hasta=${document.getElementById('fHasta').value}`)).json();
        const cont = document.getElementById('contenedorInformes'); cont.innerHTML = '';
        const sucs = {}; res.forEach(r => { if(filtro!=="TODAS" && r.suc_nombre!==filtro) return; if(!sucs[r.suc_nombre]) sucs[r.suc_nombre]=[]; sucs[r.suc_nombre].push(r); });
        for (let s in sucs) {
            let h = `<div class="bloque-empresa"><div class="bloque-title" style="background:#334155">LOCAL: ${s}</div><table class="tabla-inf"><thead><tr><th rowspan="2">FECHA</th><th rowspan="2">CAJA</th><th colspan="4" class="th-principal">PAGO F√ÅCIL</th><th colspan="4" class="th-principal">SEAC</th><th colspan="8" class="th-principal">COBRO EXPRESS</th><th rowspan="2">TOTAL</th></tr><tr><th>CANT.EF</th><th>MONTO.EF</th><th>CANT.DB</th><th class="border-right-group">MONTO.DB</th><th>CANT.EF</th><th>MONTO.EF</th><th>CANT.DB</th><th class="border-right-group">MONTO.DB</th><th>CANT.EF</th><th>MONTO.EF</th><th>DEV.</th><th>EFEC-DEV</th><th>EXT.EF</th><th>CANT.DB</th><th>MONTO.DB</th><th class="border-right-group">EXT.DB</th></tr></thead><tbody>`;
            sucs[s].forEach(r => {
                const subCE = (cleanImport(r.ce_monto_e)+cleanImport(r.ce_monto_d)-cleanImport(r.ce_extra_e)-cleanImport(r.ce_extra_d)-cleanImport(r.ce_dev));
                const total = (cleanImport(r.pf_monto_e)+cleanImport(r.pf_monto_d)) + (cleanImport(r.seac_monto_e)+cleanImport(r.seac_monto_d)) + subCE;
                h += `<tr><td>${new Date(r.fecha).toLocaleDateString()}</td><td>${r.nombre_caja}</td><td class="border-left-group">${parseInt(r.pf_cant_e)}</td><td>${fmt(r.pf_monto_e)}</td><td>${parseInt(r.pf_cant_d)}</td><td class="border-right-group">${fmt(r.pf_monto_d)}</td><td>${parseInt(r.seac_cant_e)}</td><td>${fmt(r.seac_monto_e)}</td><td>${parseInt(r.seac_cant_d)}</td><td class="border-right-group">${fmt(r.seac_monto_d)}</td><td>${parseInt(r.ce_cant_e)}</td><td>${fmt(r.ce_monto_e)}</td><td style="color:red">${fmt(r.ce_dev)}</td><td style="font-weight:bold">${fmt(r.ce_monto_e-r.ce_dev)}</td><td>${fmt(r.ce_extra_e)}</td><td>${parseInt(r.ce_cant_d)}</td><td>${fmt(r.ce_monto_d)}</td><td class="border-right-group">${fmt(r.ce_extra_d)}</td><td style="font-weight:bold">${fmt(total)}</td></tr>`;
            });
            cont.innerHTML += h + `</tbody></table></div>`;
        }
    }

    async function cargarArbol() {
        const res = await fetch('/api/arbol-configuracion'); const data = await res.json();
        const grid = document.getElementById('grid-arbol'); grid.innerHTML = ''; const sucs = {};
        const selD = document.getElementById('selSucDiario'); selD.innerHTML = '<option value="TODAS">TODAS</option>';
        data.forEach(r => {
            if (!sucs[r.suc_id]) { sucs[r.suc_id] = { id: r.suc_id, nombre: r.suc_nombre, cajas: {} }; selD.innerHTML += `<option value="${r.suc_nombre}">${r.suc_nombre}</option>`; }
            if (r.caja_id && !sucs[r.suc_id].cajas[r.caja_id]) sucs[r.suc_id].cajas[r.caja_id] = { id: r.caja_id, nombre: r.nombre_caja, terms: [] };
            if (r.term_id) sucs[r.suc_id].cajas[r.caja_id].terms.push(r);
        });
        for (let sid in sucs) {
            const s = sucs[sid];
            let h = `<div class="card-upload"><div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:5px; margin-bottom:10px;"><strong>üèõÔ∏è ${s.nombre}</strong><div><button class="icon-btn" onclick="editN('sucursales',${s.id},'${s.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="nuevaCaja(${s.id})">‚ûï</button><button class="icon-btn" onclick="borrar('sucursales',${s.id})">üóëÔ∏è</button></div></div>`;
            for (let cid in s.cajas) {
                const c = s.cajas[cid]; h += `<div style="padding:8px; background:#f8fafc; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><span>üì¶ <b>Caja:</b> ${c.nombre}</span><div><button class="icon-btn" onclick="abrirModal(${c.id})">‚ûï</button><button class="icon-btn" onclick="editN('cajas',${c.id},'${c.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="borrar('cajas',${c.id})">üóëÔ∏è</button></div></div>`;
                c.terms.forEach(t => { h += `<div style="padding:5px 10px 5px 30px; font-size:12px; display:flex; justify-content:space-between;"><span>üíª ${t.empresa}: ${t.identificador_externo} (${t.comision_porcentaje}%)</span><button class="icon-btn" style="font-size:12px;" onclick="borrar('terminales',${t.term_id})">üóëÔ∏è</button></div>`; });
            }
            grid.innerHTML += h + `</div>`;
        }
    }

    function initApp() { 
        const h = new Date(); 
        document.getElementById('fDesde').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('fHasta').value = new Date(h.getFullYear(), h.getMonth() + 1, 0).toISOString().split('T')[0];
        document.getElementById('mDesde').value = document.getElementById('fDesde').value;
        document.getElementById('mHasta').value = document.getElementById('fHasta').value;
        cargarArbol(); 
    }
    function switchTab(e, id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.getElementById(id).classList.add('active'); e.target.classList.add('active'); if(id === 'tab-config') cargarArbol(); }
    async function editN(t,id,a) { const n = prompt("Editar nombre:",a); if(n) { await fetch(`/api/${t}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); cargarArbol(); } }
    async function borrar(t,id) { if(confirm("¬øEliminar?")) { await fetch(`/api/${t}/${id}`,{method:'DELETE'}); cargarArbol(); } }
    async function nuevaCaja(sid) { const n = prompt("Nombre caja:"); if(n) { await fetch('/api/cajas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sucursal_id:sid, nombre:n})}); cargarArbol(); } }
    async function nuevaSucursal() { const n = prompt("Nombre sucursal:"); if(n) { await fetch('/api/sucursales',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); cargarArbol(); } }
    function abrirModal(cid) { document.getElementById('mCajaId').value = cid; document.getElementById('modalTerm').style.display = 'flex'; }
    async function guardarTerm() { 
        const b = { caja_id: document.getElementById('mCajaId').value, empresa: document.getElementById('mEmp').value, identificador: document.getElementById('mId').value, comision: document.getElementById('mCom').value }; 
        if(!b.identificador) return alert("ID requerido");
        await fetch('/api/terminales', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b) }); 
        document.getElementById('modalTerm').style.display = 'none'; document.getElementById('mId').value=""; cargarArbol(); 
    }
</script>
</body>
</html>