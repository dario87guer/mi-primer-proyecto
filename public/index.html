<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Transacciones Impuestos</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-principal: #6366f1;
            --color-principal-dark: #3730a3;
            --color-sec: #10b981;
            --color-nav: #18193f;
            --color-bg: #f8fafc;
            --color-bg-card: #fff;
            --color-border: #d1d5db;
            --color-fondo-table: #f3f4f6;
            --color-shadow: 0 8px 24px rgba(31,41,55,.08);
            --nav-width-min: 55px;
            --nav-width-max: 220px;
            --sombra-menu: 0 6px 26px 0 rgba(49,47,114,0.06);
            --alto-menu: 58px;
        }
        html, body {
            font-family: 'Inter', sans-serif;
            background: var(--color-bg);
            color: #334155;
            margin: 0;
            height: 100%;
            min-height: 100dvh;
        }
        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        /* Sidebar (mini por defecto) */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1010;
            width: var(--nav-width-min);
            height: 100dvh;
            background: linear-gradient(180deg,var(--color-principal-dark) 0%, #282068 100%);
            box-shadow: var(--sombra-menu);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            transition: width 0.17s cubic-bezier(.42,.1,.62,1.12);
        }
        .sidebar.expanded {
            width: var(--nav-width-max);
        }
        .sidebar-header {
            height: var(--alto-menu);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,.01);
            color: white;
            font-weight: 900;
            font-size: 17px;
            letter-spacing: 1px;
            padding: 0 12px;
            white-space: nowrap;
            overflow: hidden;
            border-bottom: 2px solid rgba(200,200,255,0.11);
        }
        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 7px;
            padding: 10px 5px;
            margin-top: 8px;
        }
        .nav-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: #e0e7ef;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 12px 0 12px 0;
            font-size: 16px;
            min-height: 46px;
            transition: background .17s, color .10s;
            box-shadow: 0 2px 5px 0 rgba(31,41,55,0.013);
        }
        .nav-btn.active,
        .nav-btn:hover {
            background: linear-gradient(90deg, var(--color-principal) 0%, #343391 85%);
            color: #fff;
        }
        .nav-icon {
            width: 28px;
            min-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 5px;
            flex-shrink: 0;
            opacity: 0.94;
        }
        .nav-label {
            display: none;
            margin-left: 19px;
            transition: opacity 0.1s;
        }
        .sidebar.expanded .nav-label {
            display: inline;
        }
        .expand-toggle-btn {
            position: absolute;
            top: 19px;
            right: -13px;
            z-index: 1020;
            width: 27px;
            height: 27px;
            background: var(--color-principal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            cursor: pointer;
            box-shadow: 0 0 10px 0 rgba(80,80,180,0.08);
            font-size: 18px;
            color: #fff;
            transition: right 0.23s;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                width: var(--nav-width-min);
                z-index: 4000;
                height: 100vh;
            }
            .sidebar.expanded {
                width: var(--nav-width-max)
            }
            .expand-toggle-btn { top: 12px; }
        }
        /* Separaci√≥n contenido */
        .main-content {
            flex: 1;
            margin-left: var(--nav-width-min);
            transition: margin-left 0.17s cubic-bezier(.42,.1,.62,1.12);
            padding: 0;
            min-width: 0;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .sidebar.expanded ~ .main-content {
            margin-left: var(--nav-width-max);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 12px 34px 12px;
        }
        /* Barra de progreso superior */
        #prog-bar-wrap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 2100;
            display: none;
        }
        #prog-bar {
            width: 0%;
            transition: width .19s cubic-bezier(.42,.04,.77,.93);
            height: 8px;
            background: linear-gradient(90deg,#fbbf24 0%,#10b981 80%);
            border-radius: 0 10px 10px 0;
        }
        #prog-bar-txt {
            position: absolute;
            right: 24px;
            top: -2px;
            color: #262727;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 1px;
            text-shadow: 0 0 3px #fff, 0 0 7px #fff;
        }
        /* Cards */
        .card-upload {
            background: var(--color-bg-card);
            border-radius: 13px;
            border: 1.3px solid var(--color-border);
            margin-bottom: 22px;
            box-shadow: var(--color-shadow);
            padding: 18px 18px 14px 18px;
            transition: box-shadow 0.1s;
        }
        .card-upload h4 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 900;
            color: var(--color-principal-dark);
            letter-spacing: .05em;
            display: flex;
            align-items: center;
        }
        .last-date {
            margin-left: 9px;
            font-size: 12px;
            background: #f0f5fd;
            color: var(--color-principal);
            border-radius: 6px;
            padding: 4px 14px;
            font-weight: 700;
        }
        .file-input {
            width: 100%;
            padding: 11px 18px;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px dashed #cbd5e1;
            margin: 13px 0 14px 0;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn-group { display: flex; gap: 9px; flex-wrap: wrap; margin-bottom: 3px; }
        .btn {
            border: none;
            padding: 9px 22px;
            border-radius: 10px;
            background: var(--color-principal);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.12s, box-shadow .11s;
            font-family: inherit;
            font-size: 15px;
            box-shadow: 0 2px 7px 0 rgba(49,47,114,0.045);
            margin-top: 2px;
            margin-bottom: 2px;
        }
        .btn-p { background: var(--color-principal); }
        .btn-s { background: var(--color-sec) }
        .btn-alt { background: #e5e7eb; color: #1e293b; box-shadow: none; }
        .btn:active { background: #4338ca; }
        /* Controls fila */
        .controls-row {
            display: flex;
            gap: 10px;
            align-items: end;
            flex-wrap: wrap;
            padding: 13px 13px 12px 13px;
            background: #fff;
            border-radius: 13px;
            margin-bottom: 22px;
            border: 1.2px solid #e5e7eb;
            box-shadow: 0 2px 12px 0 rgba(49,47,114,0.03);
        }
        .control-item label {
            font-weight: 700;
            font-size: 13px;
            color: #475569;
            margin-bottom: 5px;
        }
        .control-item { display: flex; flex-direction: column; gap: 0px; }
        input[type="date"], select, input[type="number"], input[type="text"] {
            padding: 8px 14px;
            border-radius: 7.5px;
            border: 1px solid #cbd5e1;
            font-size: 13.5px;
            font-family: inherit;
            background: #f8fafc;
            height: 36px;
            min-width: 110px;
            margin-bottom: 0;
            color: #1e293b;
        }
        /* Red */
        .sucursal-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 3px 18px 0 rgba(79,79,160,0.045);
            padding: 21px 17px 14px 20px;
            margin-bottom: 19px;
            border-left: 9px solid var(--color-principal);
        }
        .sucursal-header {
            font-size: 17px;
            font-weight: 900;
            color: var(--color-principal-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .caja-card {
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 12px; margin-bottom: 7px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #1e293b;
            box-shadow: 0 2px 7px 0 rgba(49,47,114,0.015);
        }
        .term-item {
            padding: 10px 16px 10px 46px;
            background: white;
            border: 1px solid #e7e8fd;
            margin: 8px 0 3px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            font-size: 12px;
            justify-content: space-between;
        }
        .icon-btn {
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            font-size: 16px;
            margin-left: 7px;
            transition: 0.16s;
            color: #64748b;
        }
        .icon-btn:hover { background: #e2e8f0; color: var(--color-principal);}
        /* Informes */
        .bloque-empresa {
            background: var(--color-bg-card);
            border-radius: 14px;
            box-shadow: 0 3px 18px 0 rgba(49,47,114,0.045);
            margin-bottom: 22px;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            padding-bottom: 8px;
        }
        .tabla-inf {
            width: 100%;
            border-collapse: collapse;
            min-width: 1050px;
            font-size: 12px;
            background: var(--color-fondo-table);
        }
        .tabla-inf th,
        .tabla-inf td {
            padding: 7px 4px;
            border: 1px solid #e5e7eb;
            text-align: center;
            font-size: 11.2px;
            background: inherit;
        }
        .tabla-inf th {
            background: #e0e7ef;
            font-weight: 800;
            color: #344093;
            white-space: nowrap;
        }
        .tabla-inf tr.local-title-row th {
            background: var(--color-nav) !important;
            color: white !important;
            font-size: 13.5px;
            letter-spacing: .07em;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            text-align: left !important;
            padding-left: 22px !important;
            font-weight: 900;
        }
        .th-principal {
            font-weight: 900 !important;
            font-size: 12px !important;
            border: 2px solid #344093 !important;
            background: #e7eafd !important;
            text-transform: uppercase;
            color: #18193f;
        }
        .border-left-group { border-left: 3px solid #10b981 !important; }
        .border-right-group { border-right: 3px solid #10b981 !important; }
        .row-totales {
            background: #e0f7fa !important;
            font-weight: 800 !important;
            color: #081129;
            font-size: 12px !important;
        }
        .row-resumen {
            background: #f1f5f9 !important;
            font-weight: 700 !important;
            color: #334155;
            font-size: 12px !important;
        }
        .row-gran-total {
            background: var(--color-principal-dark) !important;
            color: white !important;
            font-weight: 900;
            font-size: 13px;
            letter-spacing: .06em;
        }
        /* OCULTAR SECCIONES/TABS */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* EMERGENTES (site-dialog / modal) */
        .modal, .site-dialog {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 5000;
            background: rgba(23,29,54, .58);
            align-items: center;
            justify-content: center;
        }
        .modal-content, .dialog-content {
            background: #fff;
            border-radius: 16px;
            padding: 38px 28px 30px 28px;
            max-width: 410px;
            width: 95vw;
            box-shadow: 0 10px 42px -8px rgba(54,49,110,.18);
            margin: 0 auto;
        }
        .modal-content h3, .dialog-content h3 {
            font-size: 19px;
            font-weight: 900;
            color: var(--color-principal-dark);
            margin: 0 0 19px 0;
            line-height: 1.1;
        }
        .dialog-content label {
            font-weight: 700;
        }
        .dialog-content input[type="text"], .dialog-content input[type="number"], .dialog-content select {
            width: 100%;
            margin-top: 7px;
            margin-bottom: 14px;
            padding: 10px 14px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: #f8fafc;
        }
        .dialog-content .btn, .modal-content .btn { height: 41px; font-size: 15px; }
        /* Animaci√≥n entrada de dialogos */
        .dialog-content, .modal-content { animation: fadeInDialog .18s cubic-bezier(.42,.1,.62,1.12);}
        @keyframes fadeInDialog {
            from { transform: translateY(35px) scale(.96); opacity: 0.01;}
            to { transform: none; opacity: 1;}
        }
        /* Responsive */
        @media (max-width: 1100px) {
            .container { padding-left: 7px; padding-right: 7px; }
        }
        @media (max-width: 900px) {
            .sucursal-card, .bloque-empresa { padding-left: 5px; padding-right: 5px; }
        }
        @media (max-width: 650px) {
            .card-upload, .controls-row, .sucursal-card, .bloque-empresa { padding-left: 4px; padding-right: 4px; }
            .sidebar-header { font-size: 14px; }
        }
        @media (max-width: 540px) {
            .main-content { padding: 0 1vw; }
            .container { padding-left: 2px; padding-right: 2px; }
            .modal-content, .dialog-content { padding: 22px 7px 20px 7px; }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebarNav">
        <div class="sidebar-header">
            <span style="font-size: 23px;">üìä</span>
            <span class="logo-txt" style="margin-left:12px; font-size:20px; letter-spacing:.04em; font-weight:900;">SISTEMA</span>
        </div>
        <button class="expand-toggle-btn" id="expandBtn" onclick="toggleSidebar()" type="button"><span id="expandIco">‚ñ∂</span></button>
        <div class="sidebar-nav">
            <button class="nav-btn active" id="nav-importar" onclick="switchTab(event, 'tab-import')">
                <span class="nav-icon">üì•</span>
                <span class="nav-label">Importar</span>
            </button>
            <button class="nav-btn" id="nav-red" onclick="switchTab(event, 'tab-config')">
                <span class="nav-icon">üü°</span>
                <span class="nav-label">Red</span>
            </button>
            <button class="nav-btn" id="nav-diario" onclick="switchTab(event, 'tab-informes')">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Diario</span>
            </button>
            <button class="nav-btn" id="nav-mensual" onclick="switchTab(event, 'tab-mensual')">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Mensual</span>
            </button>
        </div>
    </div>
    <div id="prog-bar-wrap">
        <div id="prog-bar"></div>
        <div id="prog-bar-txt"></div>
    </div>
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- Importar -->
            <div id="tab-import" class="tab-content active">
                <h2 style="font-size: 21px; font-weight: 900; color: var(--color-principal-dark);margin-bottom:13px; letter-spacing:.01em">Importar Archivos</h2>
                <div class="card-upload">
                    <h4>üîµ PAGO F√ÅCIL <span id="date-pf" class="last-date">Cargando...</span></h4>
                    <div id="res-pf"></div>
                    <input type="file" id="filePF" multiple class="file-input">
                    <button class="btn btn-p" style="width:100%;max-width:200px" onclick="procesar('pagofacil', 'filePF', null, 'res-pf')">SUBIR .TXT</button>
                </div>
                <div class="card-upload">
                    <h4>üü¢ SEAC <span id="date-seac" class="last-date">Cargando...</span></h4>
                    <div id="res-seac"></div>
                    <input type="file" id="fileSEAC" multiple class="file-input">
                    <div class="btn-group">
                        <button class="btn btn-p" onclick="procesar('seac', 'fileSEAC', 'ventas', 'res-seac')">VENTAS</button>
                        <button class="btn btn-s" onclick="procesar('seac', 'fileSEAC', 'debitos', 'res-seac')">D√âBITOS</button>
                    </div>
                </div>
                <div class="card-upload">
                    <h4>üü† COBRO EXPRESS <span id="date-ce" class="last-date">Cargando...</span></h4>
                    <div id="res-ce"></div>
                    <input type="file" id="fileCE" multiple class="file-input">
                    <div class="btn-group">
                        <button class="btn btn-p" onclick="procesar('cobroexpress', 'fileCE', 'detallado', 'res-ce')">1. DETALLE</button>
                        <button class="btn btn-s" style="background:#f59e0b" onclick="procesar('cobroexpress', 'fileCE', 'diario', 'res-ce')">2. DIARIO</button>
                    </div>
                </div>
            </div>
            <!-- Red -->
            <div id="tab-config" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;margin-top:4px">
                    <h2 style="font-size: 21px; font-weight: 900; color: var(--color-principal-dark);margin:0; letter-spacing:.02em">Red y Comisiones</h2>
                    <button class="btn btn-p" onclick="nuevaSucursal()">+ Nueva Sucursal</button>
                </div>
                <div id="grid-arbol"></div>
            </div>
            <!-- Informe Diario -->
            <div id="tab-informes" class="tab-content">
                <h2 style="font-size: 21px; font-weight: 900; color: var(--color-principal-dark);margin:0 0 13px 0;">Informe Diario Detallado</h2>
                <div class="controls-row">
                    <div class="control-item">
                        <label>Desde</label>
                        <input type="date" id="fDesde">
                    </div>
                    <div class="control-item">
                        <label>Hasta</label>
                        <input type="date" id="fHasta">
                    </div>
                    <div class="control-item">
                        <label>Sucursal</label>
                        <select id="selSucDiario"><option value="TODAS">TODAS</option></select>
                    </div>
                    <button class="btn btn-p" onclick="cargarInforme()">CONSULTAR</button>
                    <button class="btn btn-s" onclick="exportarTabla('contenedorInformes', 'Diario')">EXCEL</button>
                </div>
                <div id="contenedorInformes"></div>
            </div>
            <!-- Informe Mensual -->
            <div id="tab-mensual" class="tab-content">
                <h2 style="font-size: 21px; font-weight: 900; color: var(--color-principal-dark);margin:0 0 13px 0;">Informe Mensual Consolidado</h2>
                <div class="controls-row">
                    <div class="control-item">
                        <label>Desde</label>
                        <input type="date" id="mDesde">
                    </div>
                    <div class="control-item">
                        <label>Hasta</label>
                        <input type="date" id="mHasta">
                    </div>
                    <button class="btn btn-p" onclick="cargarMensual()">GENERAR MENSUAL</button>
                    <button class="btn btn-s" onclick="exportarTabla('contenedorMensual', 'Mensual')">EXCEL</button>
                </div>
                <div id="contenedorMensual"></div>
            </div>
        </div>
    </div>
    <!-- Modal terminal-->
    <div id="modalTerm" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Terminal / Comisiones</h3>
            <input type="hidden" id="mTermId"><input type="hidden" id="mCajaId">
            <div style="margin-bottom:14px;">
                <label>Empresa:</label>
                <select id="mEmp">
                    <option value="PAGO F√ÅCIL">PAGO F√ÅCIL</option>
                    <option value="SEAC">SEAC</option>
                    <option value="COBRO EXPRESS">COBRO EXPRESS</option>
                </select>
            </div>
            <div style="margin-bottom:14px;">
                <label>ID / PDV:</label>
                <input type="text" id="mId">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:13px; margin-bottom:15px;">
                <div>
                    <label>% Efec:</label>
                    <input type="number" id="mComEfec" step="0.001" value="0">
                </div>
                <div>
                    <label>$ D√©bito:</label>
                    <input type="number" id="mComDeb" step="0.01" value="0">
                </div>
            </div>
            <div style="display:flex; gap:11px">
                <button class="btn btn-p" style="flex:1" onclick="guardarTerm()">Guardar</button>
                <button class="btn btn-alt" onclick="cerrarModal()" type="button">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- Di√°logo bonito -->
    <div id="siteDialog" class="site-dialog">
        <div class="dialog-content">
            <div id="dialogMsg" style="margin-bottom:18px; font-weight:800; color:var(--color-principal-dark); font-size:16px"></div>
            <div id="dialogInputs" style="margin-bottom:13px"></div>
            <div id="dialogButtons" style="display:flex; gap:10px; justify-content:flex-end"></div>
        </div>
    </div>
<script>
    let sidebarExpanded = false;
    function toggleSidebar() {
        sidebarExpanded = !sidebarExpanded;
        document.getElementById('sidebarNav').classList.toggle('expanded', sidebarExpanded);
        document.getElementById('expandIco').innerText = sidebarExpanded ? '‚óÄ' : '‚ñ∂';
        // Para que el contenido no se cruce, trigger margin del main-content
        document.getElementById('mainContent').style.marginLeft = sidebarExpanded ? "var(--nav-width-max)" : "var(--nav-width-min)";
    }
    // Cambios de Tabs
    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (e) (e.currentTarget || e.target).classList.add('active');
        if (id === 'tab-config') cargarArbol();
        if (id === 'tab-import') actualizarUltimasFechas();
    }

    function mostrarProgBar(p, txt) {
        document.getElementById('prog-bar-wrap').style.display = 'block';
        document.getElementById('prog-bar').style.width = p+'%';
        document.getElementById('prog-bar-txt').innerText = txt;
    }
    function ocultarProgBar() {
        document.getElementById('prog-bar').style.width = '0%';
        setTimeout(()=>{ document.getElementById('prog-bar-wrap').style.display = 'none'; }, 400);
    }
    // ALERT/CONFIRM/PROMPT personalizados
    function customAlert(msg) {
        document.getElementById('dialogMsg').innerText = msg;
        document.getElementById('dialogInputs').innerHTML = '';
        document.getElementById('dialogButtons').innerHTML = '<button class="btn btn-p" onclick="closeDialog()">OK</button>';
        document.getElementById('siteDialog').style.display = 'flex';
    }
    function customConfirm(msg, onOk) {
        document.getElementById('dialogMsg').innerText = msg;
        document.getElementById('dialogInputs').innerHTML = '';
        document.getElementById('dialogButtons').innerHTML = `<button class="btn btn-alt" onclick="closeDialog()">Cancelar</button><button class="btn btn-p" id="btnConfirmOk">Confirmar</button>`;
        document.getElementById('siteDialog').style.display = 'flex';
        document.getElementById('btnConfirmOk').onclick = () => { onOk(); closeDialog(); };
    }
    function customPrompt(msg, value, onOk) {
        document.getElementById('dialogMsg').innerText = msg;
        document.getElementById('dialogInputs').innerHTML = `<input type="text" id="promptInput" value="${value||''}" style="font-size:15.2px">`;
        document.getElementById('dialogButtons').innerHTML = `<button class="btn btn-alt" onclick="closeDialog()">Cancelar</button><button class="btn btn-p" id="btnPromptOk">Guardar</button>`;
        document.getElementById('siteDialog').style.display = 'flex';
        setTimeout(()=>document.getElementById('promptInput').focus(), 1);  // autocursor
        document.getElementById('btnPromptOk').onclick = () => { onOk(document.getElementById('promptInput').value); closeDialog(); };
    }
    function closeDialog() { document.getElementById('siteDialog').style.display = 'none'; }

    // Importaci√≥n din√°mica
    async function procesar(ruta, inId, tipo, resId) {
        const input = document.getElementById(inId);
        if (!input.files.length) return customAlert('Seleccion√° al menos un archivo.');
        mostrarProgBar(0, 'Iniciando...');
        let totN=0, totE=0, totD=0;
        for (let i=0; i < input.files.length; i++) {
            let p = Math.round(((i+1)/input.files.length)*100);
            mostrarProgBar(p, `${p}%`);
            const fd = new FormData(); fd.append('archivo', input.files[i]); if(tipo) fd.append('tipo', tipo);
            try {
                const res = await fetch(`/importar/${ruta}`, { method:'POST', body:fd });
                const d = await res.json();
                if (!res.ok) throw new Error(d.error || "Falla procesamiento");
                totN += (d.nuevos||0);
                totE += (d.errores||0);
                totD += (d.omitidos||0);
            } catch(ex) { totE++; }
        }
        ocultarProgBar();
        document.getElementById(resId).innerHTML = `<div style="padding:14px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:9px; margin-top:10px; font-weight:600; font-size:13px">‚úÖ <b>Resultado:</b><br>‚Ä¢ Nuevos: ${totN}<br>‚Ä¢ Duplicados: ${totD}<br>‚Ä¢ Errores: ${totE}</div>`;
        input.value = "";
        setTimeout(()=> { actualizarUltimasFechas(); }, 1200);
    }

    // Fechas √∫ltimas
    async function actualizarUltimasFechas() {
        try {
            const res = await fetch('/api/ultimas-fechas');
            const data = await res.json();
            const map = { "PAGO F√ÅCIL": "date-pf", "COBRO EXPRESS": "date-ce", "SEAC": "date-seac" };
            data.forEach(d => {
                if(document.getElementById(map[d.empresa])) {
                    document.getElementById(map[d.empresa]).innerText = `√öltima: ${new Date(d.ultima_fecha).toLocaleDateString()}`;
                }
            });
        } catch(e){}
    }

    // Formato n√∫mero
    function fmt(n) {
        return new Intl.NumberFormat('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(n || 0);
    }
    // Informe diario
    async function cargarInforme() {
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('fDesde').value}&hasta=${document.getElementById('fHasta').value}`)).json();
        const cont = document.getElementById('contenedorInformes'); cont.innerHTML = '';

        const filtro = document.getElementById('selSucDiario').value;
        const sucs = {};
        res.forEach(r => { if(filtro!=="TODAS" && r.suc_nombre!==filtro) return; if(!sucs[r.suc_nombre]) sucs[r.suc_nombre]=[]; sucs[r.suc_nombre].push(r); });

        for (let s in sucs) {
            let h = `<div class="bloque-empresa"><table class="tabla-inf"><thead><tr class="local-title-row"><th colspan="20">LOCAL: ${s}</th></tr>`;
            h += `<tr><th rowspan="2">FECHA</th><th rowspan="2">CAJA</th><th colspan="4" class="th-principal border-left-group border-right-group">PAGO F√ÅCIL</th><th colspan="4" class="th-principal border-right-group">SEAC</th><th colspan="8" class="th-principal border-right-group">COBRO EXPRESS</th><th rowspan="2">TOTAL</th></tr>`;
            h += `<tr><th class="border-left-group">CANT.E</th><th>MONTO.E</th><th>CANT.D</th><th class="border-right-group">MONTO.D</th><th>CANT.E</th><th>MONTO.E</th><th>CANT.D</th><th class="border-right-group">MONTO.D</th><th>CANT.E</th><th>MONTO.E</th><th>DEV</th><th>EF-DEV</th><th>EXT.E</th><th>CANT.D</th><th>MONTO.D</th><th class="border-right-group">EXT.D</th></tr></thead><tbody>`;
            let st = Array(17).fill(0);
            sucs[s].forEach(r => {
                const subCE = (parseFloat(r.ce_monto_e)+parseFloat(r.ce_monto_d)-parseFloat(r.ce_extra_e)-parseFloat(r.ce_extra_d)-parseFloat(r.ce_dev));
                const total = (parseFloat(r.pf_monto_e)+parseFloat(r.pf_monto_d)) + (parseFloat(r.seac_monto_e)+parseFloat(r.seac_monto_d)) + subCE;
                const v = [r.pf_cant_e, r.pf_monto_e, r.pf_cant_d, r.pf_monto_d, r.seac_cant_e, r.seac_monto_e, r.seac_cant_d, r.seac_monto_d, r.ce_cant_e, r.ce_monto_e, r.ce_dev, (r.ce_monto_e-r.ce_dev), r.ce_extra_e, r.ce_cant_d, r.ce_monto_d, r.ce_extra_d, total];
                v.forEach((val, i) => st[i] += parseFloat(val || 0));
                h += `<tr><td>${new Date(r.fecha).toLocaleDateString()}</td><td>${r.nombre_caja}</td><td class="border-left-group">${parseInt(v[0])}</td><td>${fmt(v[1])}</td><td>${parseInt(v[2])}</td><td class="border-right-group">${fmt(v[3])}</td><td>${parseInt(v[4])}</td><td>${fmt(v[5])}</td><td>${parseInt(v[6])}</td><td class="border-right-group">${fmt(v[7])}</td><td>${parseInt(v[8])}</td><td>${fmt(v[9])}</td><td style="color:red">${fmt(v[10])}</td><td>${fmt(v[11])}</td><td>${fmt(v[12])}</td><td>${parseInt(v[13])}</td><td>${fmt(v[14])}</td><td class="border-right-group">${fmt(v[15])}</td><td style="font-weight:800">${fmt(v[16])}</td></tr>`;
            });
            h += `<tr class="row-totales"><td colspan="2">TOTAL COLUMNAS</td><td class="border-left-group">${parseInt(st[0])}</td><td>${fmt(st[1])}</td><td>${parseInt(st[2])}</td><td class="border-right-group">${fmt(st[3])}</td><td>${parseInt(st[4])}</td><td>${fmt(st[5])}</td><td>${parseInt(st[6])}</td><td class="border-right-group">${fmt(st[7])}</td><td>${parseInt(st[8])}</td><td>${fmt(st[9])}</td><td>${fmt(st[10])}</td><td>${fmt(st[11])}</td><td>${fmt(st[12])}</td><td>${parseInt(st[13])}</td><td>${fmt(st[14])}</td><td class="border-right-group">${fmt(st[15])}</td><td>${fmt(st[16])}</td></tr>`;
            const cE = st[0]+st[4]+st[8], mE = st[1]+st[5]+st[9]-st[10], cD = st[2]+st[6]+st[13], mD = st[3]+st[7]+st[14];
            h += `<tr class="row-resumen"><td colspan="2">RESUMEN MEDIO PAGO</td><td colspan="4" class="border-left-group">EFECTIVO: ${parseInt(cE)} Facturas | $ ${fmt(mE)}</td><td colspan="4">D√âBITO: ${parseInt(cD)} Facturas | $ ${fmt(mD)}</td><td colspan="9" class="border-right-group"></td></tr>`;
            h += `<tr class="row-gran-total"><td colspan="2">GRAN TOTAL LOCAL</td><td colspan="17">TOTAL GENERAL: ${parseInt(cE+cD)} FACTURAS COBRADAS | IMPORTE TOTAL: $ ${fmt(mE+mD)}</td></tr></tbody></table></div>`;
            cont.innerHTML += h;
        }
    }
    // Informe mensual
    async function cargarMensual() {
        const res = await (await fetch(`/api/informes?desde=${document.getElementById('mDesde').value}&hasta=${document.getElementById('mHasta').value}`)).json();
        const cont = document.getElementById('contenedorMensual'); cont.innerHTML = '';
        const dataEmp = { "seac": { title: "SEAC", loc: {} }, "pf": { title: "PAGO F√ÅCIL", loc: {} }, "ce": { title: "COBRO EXPRESS", loc: {} } };
        res.forEach(r => {
            ["seac","pf","ce"].forEach(k => { if(!dataEmp[k].loc[r.suc_nombre]) dataEmp[k].loc[r.suc_nombre] = Array(k==="ce"?10:5).fill(0); });
            dataEmp.seac.loc[r.suc_nombre][0]+=parseFloat(r.seac_cant_e||0); dataEmp.seac.loc[r.suc_nombre][1]+=parseFloat(r.seac_monto_e||0); dataEmp.seac.loc[r.suc_nombre][2]+=parseFloat(r.seac_cant_d||0); dataEmp.seac.loc[r.suc_nombre][3]+=parseFloat(r.seac_monto_d||0); dataEmp.seac.loc[r.suc_nombre][4]+=((parseFloat(r.seac_monto_e||0)+parseFloat(r.seac_monto_d||0)));
            dataEmp.pf.loc[r.suc_nombre][0]+=parseFloat(r.pf_cant_e||0); dataEmp.pf.loc[r.suc_nombre][1]+=parseFloat(r.pf_monto_e||0); dataEmp.pf.loc[r.suc_nombre][2]+=parseFloat(r.pf_cant_d||0); dataEmp.pf.loc[r.suc_nombre][3]+=parseFloat(r.pf_monto_d||0); dataEmp.pf.loc[r.suc_nombre][4]+=((parseFloat(r.pf_monto_e||0)+parseFloat(r.pf_monto_d||0)));
            const mEf = parseFloat(r.ce_monto_e||0), mDe = parseFloat(r.ce_monto_d||0), dev = parseFloat(r.ce_dev||0);
            dataEmp.ce.loc[r.suc_nombre][0]+=parseFloat(r.ce_cant_e||0); dataEmp.ce.loc[r.suc_nombre][1]+=mEf; dataEmp.ce.loc[r.suc_nombre][2]+=dev; dataEmp.ce.loc[r.suc_nombre][3]+=(mEf-dev); dataEmp.ce.loc[r.suc_nombre][4]+=parseFloat(r.ce_extra_e||0); dataEmp.ce.loc[r.suc_nombre][5]+=parseFloat(r.ce_cant_d||0); dataEmp.ce.loc[r.suc_nombre][6]+=mDe; dataEmp.ce.loc[r.suc_nombre][7]+=parseFloat(r.ce_extra_d||0); dataEmp.ce.loc[r.suc_nombre][8]+=(parseFloat(r.ce_cant_e||0)+parseFloat(r.ce_cant_d||0)); dataEmp.ce.loc[r.suc_nombre][9]+=(mEf+mDe-parseFloat(r.ce_extra_e||0)-parseFloat(r.ce_extra_d||0)-dev);
        });
        for (let k in dataEmp) {
            const e = dataEmp[k];
            let h = `<div class="bloque-empresa"><table class="tabla-inf"><thead><tr class="local-title-row"><th colspan="${k==='ce'?12:7}">${e.title} - ACUMULADO MENSUAL</th></tr>`;
            h += `<tr><th>LOCAL</th><th class="border-left-group">CANT.E</th><th>MONTO.E</th>${k==='ce'?'<th>DEV</th><th>EF-DEV</th><th>EXT.E</th>':''}<th>CANT.D</th><th>MONTO.D</th>${k==='ce'?'<th>EXT.D</th><th>CANT.TOT</th>':''}<th class="border-right-group">SUBTOTAL</th></tr></thead><tbody>`;
            for (let l in e.loc) { h += `<tr><td style="text-align:left; font-weight:bold">${l}</td>`; e.loc[l].forEach((v,i)=> h += `<td class="${i===0?'border-left-group':i===e.loc[l].length-1?'border-right-group':''}">${([0,2,5,8].includes(i)&&(k==='ce')||[0,2].includes(i)&&k!=='ce') ? parseInt(v) : fmt(v)}</td>`); h += `</tr>`; }
            cont.innerHTML += h + `</tbody></table></div>`;
        }
    }
    // Red (sucursales/cajas/terminales)
    async function cargarArbol() {
        const res = await fetch('/api/arbol-configuracion'); const data = await res.json();
        const grid = document.getElementById('grid-arbol'); grid.innerHTML = ''; const sucs = {};
        const selD = document.getElementById('selSucDiario'); selD.innerHTML = '<option value="TODAS">TODAS</option>';
        data.forEach(r => {
            if (!sucs[r.suc_id]) { sucs[r.suc_id] = { id: r.suc_id, nombre: r.suc_nombre, cajas: {} }; selD.innerHTML += `<option value="${r.suc_nombre}">${r.suc_nombre}</option>`; }
            if (r.caja_id && !sucs[r.suc_id].cajas[r.caja_id]) sucs[r.suc_id].cajas[r.caja_id] = { id: r.caja_id, nombre: r.nombre_caja, terms: [] };
            if (r.term_id) sucs[r.suc_id].cajas[r.caja_id].terms.push(r);
        });
        for (let sid in sucs) {
            const s = sucs[sid];
            let h = `<div class="sucursal-card"><div class="sucursal-header">üèõÔ∏è ${s.nombre}<div><button class="icon-btn" onclick="editSuc(${s.id},'${s.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="nuevaCaja(${s.id})">‚ûï</button><button class="icon-btn" onclick="borrar('sucursales',${s.id})">üóëÔ∏è</button></div></div>`;
            for (let cid in s.cajas) {
                const c = s.cajas[cid]; h += `<div class="caja-card">üì¶ ${c.nombre}<div><button class="icon-btn" onclick="abrirModal(${c.id})">‚ûï</button><button class="icon-btn" onclick="editCaja(${c.id},'${c.nombre}')">‚úèÔ∏è</button><button class="icon-btn" onclick="borrar('cajas',${cid})">üóëÔ∏è</button></div></div>`;
                c.terms.forEach(t => { h += `<div class="term-item"><span>üíª <b>${t.empresa}:</b> ${t.identificador_externo} <small>(${t.comision_porcentaje_efectivo}% | $${t.comision_fija_debito})</small></span><div><button class="icon-btn" onclick='editarTerm(${JSON.stringify(t)})'>‚úèÔ∏è</button><button class="icon-btn" onclick="borrar('terminales',${t.term_id})">üóëÔ∏è</button></div></div>`; });
            }
            grid.innerHTML += h + `</div>`;
        }
    }
    // Exportar tabla a excel
    function exportarTabla(id, name) {
        const cont = document.getElementById(id);
        if (!cont.outerHTML.trim()) return customAlert("Sin datos.");
        const wb = XLSX.utils.book_new();
        cont.querySelectorAll('table').forEach((t, i) => XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(t), `Hoja_${i+1}`));
        XLSX.writeFile(wb, `${name}_${new Date().toLocaleDateString()}.xlsx`);
    }
    // Red edici√≥n
    async function editSuc(id, n) {
        customPrompt("Editar Sucursal:", n, async (val) => {
            await fetch(`/api/sucursales/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({nombre:val})
            }); cargarArbol();
        });
    }
    async function editCaja(id, n) {
        customPrompt("Editar Caja:", n, async (val) => {
            await fetch(`/api/cajas/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({nombre:val})
            }); cargarArbol();
        });
    }
    async function nuevaCaja(sid) {
        customPrompt("Nombre de Caja:", "", async (val) => {
            await fetch('/api/cajas',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({sucursal_id:sid, nombre:val})
            }); cargarArbol();
        });
    }
    async function nuevaSucursal() {
        customPrompt("Nombre de Sucursal:", "", async (val) => {
            await fetch('/api/sucursales',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({nombre:val})
            }); cargarArbol();
        });
    }
    async function borrar(t, id) {
        customConfirm("¬øSeguro de eliminar este registro?", async () => {
            await fetch(`/api/${t}/${id}`,{method:'DELETE'});
            cargarArbol();
        });
    }
    // Terminales
    function abrirModal(cid) {
        document.getElementById('modalTitle').innerText="Nueva Terminal";
        document.getElementById('mCajaId').value=cid;
        document.getElementById('mTermId').value="";
        document.getElementById('mId').value="";
        document.getElementById('mComEfec').value=0;
        document.getElementById('mComDeb').value=0;
        document.getElementById('mEmp').value="PAGO F√ÅCIL";
        document.getElementById('modalTerm').style.display='flex';
    }
    function editarTerm(t) {
        document.getElementById('modalTitle').innerText="Editar Terminal";
        document.getElementById('mTermId').value=t.term_id;
        document.getElementById('mEmp').value=t.empresa;
        document.getElementById('mId').value=t.identificador_externo;
        document.getElementById('mComEfec').value=t.comision_porcentaje_efectivo;
        document.getElementById('mComDeb').value=t.comision_fija_debito;
        document.getElementById('mCajaId').value=t.caja_id;
        document.getElementById('modalTerm').style.display='flex';
    }
    function cerrarModal() { document.getElementById('modalTerm').style.display='none'; }
    async function guardarTerm() {
        const id = document.getElementById('mTermId').value;
        const b = {
            caja_id: document.getElementById('mCajaId').value,
            empresa: document.getElementById('mEmp').value,
            identificador: document.getElementById('mId').value,
            com_efectivo: document.getElementById('mComEfec').value,
            com_debito: document.getElementById('mComDeb').value
        };
        if(!b.identificador) return customAlert("ID requerido");
        const url = id ? `/api/terminales/${id}` : '/api/terminales';
        await fetch(url, {
            method: id ? 'PUT' : 'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(b)
        });
        cerrarModal(); cargarArbol();
    }
    // Onload: setear fechas y cargar √∫ltimas fechas
    window.onload = () => {
        // Por defecto selecciona mes actual
        const h = new Date();
        document.getElementById('fDesde').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('fHasta').value = new Date(h.getFullYear(), h.getMonth() + 1, 0).toISOString().split('T')[0];
        document.getElementById('mDesde').value = document.getElementById('fDesde').value;
        document.getElementById('mHasta').value = document.getElementById('fHasta').value;
        actualizarUltimasFechas();
    };
</script>
</body>
</html>