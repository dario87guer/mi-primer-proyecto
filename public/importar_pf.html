<div style="padding: 20px;">
    <button class="btn" onclick="loadSection('importar')" style="margin-bottom:20px; background:#64748b;">‚Üê Volver al Selector</button>
    
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <span style="font-size: 30px;">üîµ</span>
        <h2 style="font-weight: 900; color: #6366f1; margin: 0;">Importador PAGO F√ÅCIL (.TXT)</h2>
    </div>

    <div class="card-upload" style="border-top: 5px solid #6366f1;">
        <p style="font-weight: 700; color: #475569;">1. Seleccione uno o varios archivos .TXT de Pago F√°cil:</p>
        <input type="file" id="filePF" multiple class="file-input" accept=".txt">
        
        <p style="font-weight: 700; color: #475569; margin-top: 20px;">2. Iniciar procesamiento de archivos:</p>
        <button class="btn" onclick="procesarPF()" style="background: #6366f1; width: 100%; max-width: 300px;">SUBIR ARCHIVOS TXT</button>

        <div id="progreso-pf" style="display:none; margin-top: 20px;">
            <div style="height: 10px; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
                <div id="barra-pf" style="width: 0%; height: 100%; background: #6366f1; transition: width 0.3s;"></div>
            </div>
            <p id="txt-proceso-pf" style="font-size: 12px; font-weight: 700; margin-top: 5px; color: #64748b;"></p>
        </div>

        <div id="res-pf" style="margin-top: 20px;"></div>
    </div>
</div>
<script>
    async function procesarPF() {
        const input = document.getElementById('filePF');
        const resDiv = document.getElementById('res-pf');
        const progDiv = document.getElementById('progreso-pf');
        const barra = document.getElementById('barra-pf');
        
        if (!input.files.length) return alert('Por favor, seleccion√° archivos TXT de Pago F√°cil.');

        resDiv.innerHTML = "";
        progDiv.style.display = "block";
        let totN = 0, totE = 0, totD = 0;

        for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const p = Math.round(((i + 1) / input.files.length) * 100);
            barra.style.width = p + "%";
            document.getElementById('txt-proceso-pf').innerText = `Leyendo: ${file.name}`;

            const fd = new FormData();
            fd.append('archivo', file);
            // El backend ya sabe que si la ruta es /pagofacil debe tratarlo como TXT

            try {
                const response = await fetch('/importar/pagofacil', { 
                    method: 'POST', 
                    body: fd 
                });
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || "Error en servidor");
                
                totN += (data.nuevos || 0);
                totE += (data.errores || 0);
                totD += (data.omitidos || 0);
            } catch (err) {
                console.error(err);
                totE++;
            }
        }

        progDiv.style.display = "none";
        resDiv.innerHTML = `
            <div style="padding:15px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:10px;">
                <h4 style="margin-top:0; color:#1e40af;">‚úÖ Importaci√≥n Pago F√°cil Finalizada</h4>
                <ul style="margin-bottom:0; font-size:14px; font-weight:700;">
                    <li>Registros Nuevos: ${totN}</li>
                    <li>Omitidos (Duplicados o Terminal no mapeada): ${totD}</li>
                    <li>Errores: ${totE}</li>
                </ul>
            </div>`;
        input.value = "";
    }
</script>